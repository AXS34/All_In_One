### 计算网格流体

网格流体可以快速的模拟大尺度范围下的液体流动的状态,这种优势正是 SPH 所不能比拟的。在软件 Houdini中, 流体的每个网格中只能存储一个 float ( 浮点) 类型的数据信息, 在需要存储像 velocity(速度)这样的 vector(向量)数据类型的时候, 就需要额外的三个 volume(体积元素) 进行存储。在 Fluid solver(流体解算器)中, Viscosity(粘稠度)属性是非常重要的,其对液体的空间尺度起到的了决定性的作用。 同时, 流体会自动在 density(密度) 存在差异的网格间产生表面, 表面内部的密度值比外部的密度值小,以下是使用 Houdini 所进行的液体流体模拟结果。两次模拟的网格精度分别为 200×100×150、 300×150×225

###  液体的粒子形态

现实中的液体, 例如水, 其由于表面张力、 重力、 粘性等属性的共同作用,会产生粒子粘连的效果。但在三维软件中, 直接从发射器发射出来的粒子是没有任何的形态的, 为了模拟液体在飞溅时的效果,必须是粒子在发射之初就产生粘连的效果。在 Houdini 中, 粒子可以由粒子发射,并且由同一个粒子产生的粒子具有粘连的效果, 因此使用这种方法可以快速的模拟出诸如瀑布的效果。由于粒子出生后粒子间并不存在交互计算, 因此生成速度是普通 SPH 方法的几百倍,并且可以轻松的产生几百万的粒子。 在渲染时 ,可以使用粒子转成多边形表面进行渲染,也可以直接以粒子形态进行渲染。粒子模拟水花形态测试 (粒子) :粒子模拟水花形态测试:

### 发射器的提取
在现实中,真正的液体会在其碰撞或者其加速很大的情况下,从表面溢出大量的水花。在 Houdini 中, 粒子溢出的位置无法自动获取,而是需要通过计算得出。液体表面与流体间的属性转换是其中最重要的过程。在 Houdini 的VOP 使用液体表面的顶点位置找到空间中流体的属性信息, 然后需要用定点速度的方向与其法线方向进行点乘所得到的结果就是两向量间的夹角的余弦值,而后判断值是否大于零,是则发射粒子, 否则不发射。其含义是液体表面不会向其内部发射粒子。

### 粒子的状态

得到液体表面发射器后, 粒子就可以设置其发射速率,以控制其发射数量。经过与真实粒子的反复比较,我确定了粒子在空间中会处于两种状体, 一种为液外状态, 一种为液内状态。当粒子处于液外状态时,其速度受惯性及空间中的场 (例如:重力场、 风场, 空气阻力等等) 的影响,而当粒子处于液内状态时,其会受到流体速度及浮力的影响。因此, 当粒子产生以后, 其状态就应该被确定下来。由于液体的表面是由流体的 Density(密度) 属性控制的, 因此就可以使用粒子当前的位置属性找到其相对应的空间中的流体密度值,使用其确定当前粒子的状态。粒子可以是在液体表面发射,也可以是由其他物体发射。此环节是整个技术思路的核心环节,是在 Houdini 中的 VOP 中使用节点判断的方式实现的

### 飞溅的粒子

粒子在脱离液体表面时需要继承液体表面的速度, 如果单纯的继承液面的速度属性, 其形态会很有规律, 因此在发射时需要给每个粒子随机的速度变化值。使用 rand()(随机函数) 可以使粒子具有不同的速度, 但是会产生粒子雾状的效果, 如果要想实现连续的飞溅粒子, 在这我巧妙的使用了 3D texture(三维空间纹理)。三维空间纹理可以使用粒子的空间位置信息得到一个扰乱的向量值。使用 length()函数求得速率,用其控制粒子速度扰乱的大小,发射速度越快的粒子,扰乱值越大。此过程实现了水花参差不齐的边缘效果。粒子在空中的形态可以使用各种动力学场进行控制,例如使用扰动场控制粒子在空中的飞舞。

### 深度贴图阴影与体积渲染

粒子在渲染时可以有两种存在方式。第一种是直接渲染粒子点的方式, 这也是最快的方式, 其适用于大量的水花模拟。第二种方式是将粒子转换为多边形表面进行渲染,速度较慢,适用于近景的浪花效果。在最后的效果中为了体现粒子的体积感,在灯光 设 置中使 用到 了 depth map shadow (深度贴图阴影) ,并可使用红绿蓝三色灯进行渲染。如下图 (动画长度为 101 帧, 粒子数量为 180 万,使用Dell T5400 工作站解算时间每帧约为 43 秒, 渲染每帧约为94 秒, 内存占用 2.4G)三色光源的摆放要看镜头的需要,在后期中能够很方便的将个通道拆分开来,从而达到快速调节灯光效果的目的。深度贴图阴影的使用,使得粒子的体积感得到充分的体现, 配合物理解算的动态与画面效果, 在中远景别的水花效果完全可以以假乱真

在实际制作过程中, 参数调整环节较为费时, 但最基本的属性, 例如重力场, 在场景尺寸确定下来后就不应进行过多改动, 因为不管怎样, CG 特效制作最终强调的还是真实感, 毕竟物体的客观物理规律还是必须要遵循的。


[From](https://kns.cnki.net/kns/detail/detail.aspx?QueryID=5&CurRec=3&recid=&FileName=OGSA201111001039&DbName=CPFD0914&DbCode=CPFD&yx=&pr=&URLID=&bsm=)--视觉特效技术和开发与创新——网格流体与粒子相结合快速模拟真实的流体效果
